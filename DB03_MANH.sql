CREATE DATABASE DB03_MANH;
USE DB03_MANH ; 
CREATE TABLE CATEGORY 
(CATEGORY_ID CHAR(3) PRIMARY KEY,
CATEGORY_NAME VARCHAR(50)) ; 

CREATE TABLE PRODUCT
(PRODUCT_ID CHAR(3) PRIMARY KEY, 
PRODUCT_NAME VARCHAR(50),
UNIT_PRICE INT CHECK (UNIT_PRICE > 0),
CATEGORY_ID CHAR(3),
FOREIGN KEY (CATEGORY_ID) REFERENCES CATEGORY(CATEGORY_ID)) ; 

CREATE TABLE WAREHOUSE 
(WAREHOUSE_ID CHAR(3) PRIMARY KEY,
WAREHOUSE_ADDRESS VARCHAR(150),
CATEGORY_ID CHAR(3),
FOREIGN KEY (CATEGORY_ID) REFERENCES CATEGORY(CATEGORY_ID)) ; 


CREATE TABLE INSTOCK 
(WAREHOUSE_ID CHAR(3),
PRODUCT_ID CHAR(3),
QUANTITY INT CHECK(QUANTITY >= 0),
PRIMARY KEY (PRODUCT_ID, WAREHOUSE_ID),
FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCT(PRODUCT_ID),
FOREIGN KEY (WAREHOUSE_ID) REFERENCES WAREHOUSE(WAREHOUSE_ID)) ; 

INSERT INTO CATEGORY (CATEGORY_ID, CATEGORY_NAME) VALUES 
("C01", "ELECTRONICS"), 
("C02", "CLOTHING"), 
("C03", "FURNITURE");

INSERT INTO PRODUCT (PRODUCT_ID, PRODUCT_NAME, UNIT_PRICE, CATEGORY_ID) VALUES 
("P01", "LAPTOP", 1000, "C01"), 
("P02", "SMARTPHONE", 800, "C01"), 
("P03", "T-SHIRT", 20, "C02"), 
("P04", "JEANS", 50, "C02"), 
("P05", "SOFA", 500, "C03"), 
("P06", "TABLE", 300, "C03");

INSERT INTO WAREHOUSE (WAREHOUSE_ID, WAREHOUSE_ADDRESS, CATEGORY_ID) VALUES 
("W01", "123 MAIN ST, CITY A", "C01"), 
("W02", "456 MARKET ST, CITY B", "C02"), 
("W03", "789 OAK ST, CITY C", "C03");

INSERT INTO INSTOCK (WAREHOUSE_ID, PRODUCT_ID, QUANTITY) VALUES 
("W01", "P01", 50), 
("W01", "P02", 30), 
("W02", "P03", 100), 
("W02", "P01", 80), 
("W03", "P05", 20), 
("W03", "P01", 15),
("W03", "P02", 15),
("W03", "P06", 15);



SELECT PRODUCT_ID, PRODUCT_NAME 
FROM PRODUCT 
WHERE CATEGORY_ID = 'C02'; 

SELECT * 
FROM WAREHOUSE 
WHERE CATEGORY_ID = 'C01' ;

SELECT WARE.* 
FROM WAREHOUSE AS WARE
JOIN INSTOCK AS INS ON INS.WAREHOUSE_ID = WARE.WAREHOUSE_ID 
JOIN PRODUCT AS PRO ON PRO.PRODUCT_ID = INS.PRODUCT_ID
WHERE PRODUCT_NAME = 'LAPTOP' ; 

SELECT PRO.* 
FROM PRODUCT AS PRO
JOIN INSTOCK AS INS ON INS.PRODUCT_ID = PRO.PRODUCT_ID 
WHERE WAREHOUSE_ID = 'W01' ; 

SELECT WAREHOUSE_ID, SUM(QUANTITY) 
FROM INSTOCK 
GROUP BY WAREHOUSE_ID ; 

SELECT WAREHOUSE_ID, SUM(QUANTITY) 
FROM INSTOCK 
GROUP BY WAREHOUSE_ID
HAVING SUM(QUANTITY) = 
(SELECT MAX(MAX_QUANTITY) 
FROM(SELECT WAREHOUSE_ID, SUM(QUANTITY) AS MAX_QUANTITY
FROM INSTOCK 
GROUP BY WAREHOUSE_ID) AS FIND_MAX) ; 

SELECT WAREHOUSE_ID, COUNT(PRODUCT_ID) AS NUMBER_OF_PRODUCT
FROM INSTOCK
GROUP BY WAREHOUSE_ID ; 

SELECT WAREHOUSE_ID, COUNT(PRODUCT_ID) AS NUMBER_OF_PRODUCT 
FROM INSTOCK 
GROUP BY WAREHOUSE_ID
HAVING NUMBER_OF_PRODUCT =
(SELECT MAX(LAGEST_NUMBER) 
FROM (
    SELECT WAREHOUSE_ID, COUNT(PRODUCT_ID) AS LAGEST_NUMBER
    FROM INSTOCK
    GROUP BY WAREHOUSE_ID 
) SUB_QUEY) ; 


SELECT PRO.*, SUM(INS.QUANTITY) AS TOTAL_PRODUCT_QUANTITY
FROM PRODUCT AS PRO 
JOIN INSTOCK AS INS ON INS.PRODUCT_ID = PRO.PRODUCT_ID 
GROUP BY PRODUCT_ID ;

SELECT PRO.*, SUM(INS.QUANTITY) AS LAGEST_TOTAL_QUANTITY
FROM PRODUCT AS PRO
JOIN INSTOCK AS INS ON INS.PRODUCT_ID = PRO.PRODUCT_ID 
GROUP BY PRODUCT_ID 
HAVING LAGEST_TOTAL_QUANTITY = 
(SELECT MAX(LAGEST) 
FROM (
    SELECT PRODUCT_ID, SUM(QUANTITY) AS LAGEST
    FROM INSTOCK 
    GROUP BY PRODUCT_ID
) AS SUB_QUEY) ;